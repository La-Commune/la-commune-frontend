rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // config/admin — contiene pinHmac (hash HMAC, no el PIN) y pinLength
    // El HMAC sin la clave ADMIN_HMAC_KEY del servidor es inútil
    match /config/admin {
      allow read: if true;
      allow create, update: if request.resource.data.keys().hasOnly(['pinHmac','pinLength'])
                            && request.resource.data.pinHmac is string
                            && request.resource.data.pinLength is int
                            && request.resource.data.pinLength >= 4
                            && request.resource.data.pinLength <= 12;
      allow delete: if false;
    }

    // rewards — solo lectura (la app necesita leer "default" al crear tarjeta)
    match /rewards/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // customers — cualquiera puede crear (onboarding), solo lectura propia
    match /customers/{customerId} {
      allow create: if true;
      allow read:   if true;
      allow update, delete: if false;
    }

    // cards — lectura pública (cliente accede por URL con su cardId)
    //         actualización permitida (addStamp corre en el browser con runTransaction)
    match /cards/{cardId} {
      allow read:   if true;
      allow create: if true;
      allow update: if true;   // necesario para addStamp desde el browser
      allow delete: if false;
    }

    // stamp-events — solo escritura desde el browser (addStamp), sin lectura pública
    match /stamp-events/{eventId} {
      allow create: if true;
      allow read, update, delete: if false;
    }
  }
}
